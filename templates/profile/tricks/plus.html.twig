{% extends 'base.html.twig' %}

{% block title %}Ajouter une figure
{% endblock %}

{% block body %}
	<section
		class="relative bg-[#D9E2F1] pb-12">
		<!-- Hero image -->
		<div class="absolute inset-0">
			<img src="{{ asset('assets/images/image-cover.jpg') }}" alt="Hero" class="w-full h-[400px] sm:h-[500px] md:h-[600px] object-cover brightness-75">
			<div class="absolute inset-0 bg-gradient-to-b from-transparent to-white/80"></div>
		</div>

		<div class="relative z-10 container mx-auto px-4 sm:px-6 md:px-12 lg:px-20 xl:px-32 pt-20 ">
			<div
				class="bg-white rounded-xl shadow-lg max-w-6xl mx-auto overflow-hidden pb-[42px]">

				{# Flash messages #}
				{% for label, messages in app.flashes %}
					{% for message in messages %}
						<div class="p-4 mb-4 rounded bg-green-100 text-green-800">{{ message }}</div>
					{% endfor %}
				{% endfor %}

				{{ form_start(form, { attr: { novalidate:'novalidate', enctype:'multipart/form-data' } }) }}

				{# ----------------- Featured Image ----------------- #}
				<div class="mb-[42px]">
					{% set featuredImagePath =
                    tempFeaturedImage and not form.deleteFeaturedImage.vars.data
                        ? asset('uploads/featured_images_tmp/' ~ tempFeaturedImage)
                        : (trick.featuredImage ? asset('uploads/featured_images/' ~ trick.featuredImage) : null)
                %}
					<div id="featured-container" data-existing-image="{{ featuredImagePath }}" class="w-full aspect-video border-2 flex items-center justify-center cursor-pointer overflow-hidden relative transition-all duration-300 hover:border-blue-400 hover:bg-gray-50 bg-[#E5E6EA]">
						<img id="featured-preview" src="{{ featuredImagePath }}" class="absolute inset-0 w-full h-full object-cover object-center transition-opacity duration-300 {% if featuredImagePath %}opacity-100{% else %}opacity-0{% endif %}">
						<span id="featured-placeholder" class="absolute text-white transition-opacity duration-300 text-center" style="font-size:24px;">
							<i class="bi bi-person-circle"></i>
						</span>

						{{ form_widget(form.featuredImage, { attr: { class: 'absolute w-full h-full opacity-0 cursor-pointer rounded-full', accept: 'image/png, image/jpeg, image/webp' } }) }}
						<div class="absolute top-2 right-2 flex gap-2">
							<button type="button" id="edit-featured" class="p-2 rounded bg-[#1b84ff] hover:bg-[#056ee9] text-white">
								<i class="bi bi-pencil"></i>
							</button>
							<button type="button" id="delete-featured" class="p-2 rounded bg-[#f8285a] text-white hover:bg-[#d81a48]">
								<i class="bi bi-trash"></i>
							</button>
						</div>
						{{ form_widget(form.deleteFeaturedImage) }}
					</div>
					<div class="text-red-500 text-sm mt-2">{{ form_errors(form.featuredImage) }}</div>
				</div>

				{# ----------------- Prototypes Symfony ----------------- #}
				{% set imagePrototype %}
				<div class="media-item media-image flex-shrink-0 w-40 snap-start relative">
					<div class="mb-3 w-full aspect-video rounded overflow-hidden border relative">
						<img class="image-preview hidden w-full h-full object-cover object-center"/>
						<div class="image-placeholder absolute inset-0 bg-gray-100 flex items-center justify-center rounded border">
							<i class="bi bi-image text-2xl text-gray-400"></i>
						</div>
					</div>
					<input type="hidden" class="removed-image" name="removed_images[]">
					<div class="media-actions flex justify-end gap-2 mt-2">
						<div class="flex flex-row-reverse items-center gap-2">
							<button type="button" class="remove-item p-2 rounded border border-[#f8285a] bg-white text-[#f8285a] hover:bg-[#f8285a] hover:text-white">
								<i class="bi bi-x-square-fill"></i>
							</button>
							<button type="button" class="item-add p-2 rounded border border-[#1b84ff] bg-white hover:bg-[#1b84ff] hover:text-white">
								<i class="bi bi-plus-square-fill"></i>
							</button>
							<button type="button" class="item-edit p-2 rounded bg-[#e9f3ff] hover:bg-[#1b84ff] hover:text-white text-[#1b84ff] transition hidden">
								<i class="bi bi-plus-square-fill"></i>
							</button>
							<button type="button" class="item-close p-2 rounded border border-[#f6c000] bg-white hover:bg-[#f6c000] hover:text-white text-[#f6c000] transition hidden">
								<i class="bi bi-eye-slash-fill"></i>
							</button>

							{{ form_widget(form.images.vars.prototype.file, {
                            attr: {
                                class: 'item-input h-10 w-0 opacity-0 transition-all duration-300 border rounded px-3 text-sm file:h-full file:border-0 file:bg-transparent',
                                accept: 'image/png,image/jpeg,image/webp'
                            }
                        }) }}
						</div>
					</div>
				</div>
				{% endset %}

				{% set videoPrototype %}
				<div class="media-item media-video flex-shrink-0 w-40 snap-start relative">
					<div class="mb-3 w-full aspect-video rounded border relative">
						<iframe class="hidden w-full h-full rounded border" frameborder="0" allowfullscreen></iframe>
						<div class="video-placeholder absolute inset-0 bg-gray-100 flex items-center justify-center rounded border">
							<i class="bi bi-play-btn text-3xl text-gray-400"></i>
						</div>
					</div>
					<input type="hidden" class="removed-video" name="removed_videos[]">
					<div class="media-actions flex justify-end gap-2 mt-2">
						<div class="flex flex-row-reverse items-center gap-2">
							<button type="button" class="remove-item p-2 rounded border border-[#f8285a] bg-white text-[#f8285a] hover:bg-[#f8285a] hover:text-white">
								<i class="bi bi-x-square-fill"></i>
							</button>
							{{ form_widget(form.videos.vars.prototype.url, {
                            attr: { class: 'item-input w-0 opacity-0 transition-all duration-300 border rounded px-3 py-2', placeholder: 'Lien YouTube' }
                        }) }}
						</div>
					</div>
				</div>
				{% endset %}

				<div id="image-prototype" class="hidden" data-prototype="{{ imagePrototype|e('html_attr') }}"></div>
				<div id="video-prototype" class="hidden" data-prototype="{{ videoPrototype|e('html_attr') }}"></div>

				{# ----------------- Carousel Images/Vidéos ----------------- #}
				<div class="relative w-full px-4 md:px-8 lg:px-8 overflow-hidden ">
					<div
						id="media-wrapper" class="flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory">

						{# Images temporaires #}
						{% for tempImage in tempImages %}
							<div class="media-item media-image flex-shrink-0 w-40 snap-start relative">
								<div class="mb-3 w-full aspect-video rounded overflow-hidden border">
									<img src="{{ asset('uploads/images_tmp/' ~ tempImage) }}" class="w-full h-full object-cover" data-filename="{{ tempImage }}">
								</div>
								<input type="hidden" class="removed-image" name="removed_images[]">
								<div class="media-actions flex justify-end gap-2 mt-2">
									<button type="button" class="remove-item p-2 rounded border border-[#f8285a] bg-[#f8285a] text-white hover:bg-[#d81a48]">
										<i class="bi bi-trash"></i>
									</button>
								</div>
							</div>
						{% endfor %}

						{# Images existantes #}
						{% for imageForm in form.images %}
							<div class="media-item media-image flex-shrink-0 w-40 snap-start relative">
								{% if imageForm.vars.data and imageForm.vars.data.picture %}
									<div class="mb-3 w-full aspect-video rounded overflow-hidden border">
										<img src="{{ asset('uploads/images/' ~ imageForm.vars.data.picture) }}" class="w-full h-full object-cover" data-filename="{{ imageForm.vars.data.picture }}">
									</div>
								{% else %}
									<div class="image-placeholder bg-gray-100 w-full aspect-video flex items-center justify-center rounded border mb-3">
										<i class="bi bi-image text-2xl text-gray-400"></i>
									</div>
								{% endif %}
								<input type="hidden" class="removed-image" name="removed_images[]">
								<div class="media-actions flex justify-end gap-2 mt-2">
									{{ form_widget(imageForm.file, {
                                    attr: {
                                        class: 'item-input h-10 w-0 opacity-0 transition-all duration-300 border rounded px-3 text-sm file:h-full file:border-0 file:bg-transparent',
                                        accept: 'image/png,image/jpeg,image/webp'
                                    }
                                }) }}
									<button type="button" class="remove-item p-2 rounded border border-[#f8285a] bg-[#f8285a] text-white hover:bg-[#d81a48]">
										<i class="bi bi-trash"></i>
									</button>
								</div>
							</div>
						{% endfor %}

						{# Vidéos existantes #}
						{% for videoForm in form.videos %}
							<div class="media-item media-video flex-shrink-0 w-40 snap-start relative">
								<div class="video-container mb-3 w-full aspect-video rounded border relative">
									<iframe src="{{ videoForm.vars.data.getEmbedUrl()|default('') }}" class="w-full h-full rounded border" frameborder="0" allowfullscreen></iframe>
									<div class="video-placeholder bg-gray-100 w-full h-full flex items-center justify-center rounded border absolute inset-0 {{ videoForm.vars.data.getEmbedUrl() ? 'hidden' : '' }}">
										<i class="bi bi-play-btn text-3xl text-gray-400"></i>
									</div>
								</div>
								<input type="hidden" class="removed-video" name="removed_videos[]">
								<div class="media-actions flex justify-end gap-2 mt-2">
									{{ form_widget(videoForm.url, {
                                    attr: {
                                        class: 'item-input w-0 opacity-0 transition-all duration-300 border rounded px-3 py-2',
                                        placeholder: 'Lien YouTube'
                                    }
                                }) }}
									<button type="button" class="remove-item p-2 rounded border border-[#f8285a] bg-[#f8285a] text-white hover:bg-[#d81a48]">
										<i class="bi bi-trash"></i>
									</button>
								</div>
							</div>
						{% endfor %}
					</div>

					<div class="flex justify-center gap-4 mt-[42px] mb-[42px]">
						<button type="button" id="add-image" class="px-4 py-2 bg-[#e9f3ff] text-[#1b84ff] rounded hover:text-white hover:bg-[#056ee9]">
							<i class="bi bi-plus-square-fill"></i>
							Ajouter une image
						</button>
						<button type="button" id="add-video" class="px-4 py-2 bg-[#e9f3ff] text-[#1b84ff] rounded hover:text-white hover:bg-[#056ee9]">
							<i class="bi bi-plus-square-fill"></i>
							Ajouter une vidéo
						</button>
					</div>
				</div>

				{# Title, Content, Category #}
				<div class="px-4 md:px-8 lg:px-24">
					{{ form_row(form.title, { attr: { class: 'w-full rounded-xl border border-[#1b84ff] bg-white px-4 py-2' } }) }}
					{{ form_row(form.content, { attr: { class: 'w-full h-28 sm:h-36 rounded-xl border border-[#1b84ff] bg-white px-4 py-2' } }) }}
					{{ form_row(form.category, { attr: { class: 'rounded-xl border border-[#1b84ff] bg-white px-4 py-2' } }) }}
					<div class="flex justify-end">
						<button class="px-4 py-2 bg-[#1b84ff] text-white rounded hover:bg-[#056ee9]">Ajouter</button>
					</div>
				</div>

				{{ form_end(form) }}
			</div>
		</div>
	</section>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{ asset('js/addFeaturedImage.js') }}"></script>
	<script src="{{ asset('js/carousel-media-repeater.js') }}"></script>
	<script src="{{ asset('js/images-temp-upload.js') }}"></script>
{% endblock %}


#[Route('/tricks/{slug}/edit-or-contribute', name: 'app_profile_tricks_edit_or_contribute')]
    public function editOrContribute(
        string $slug,
        Request $request,
        TricksRepository $repository,
        EntityManagerInterface $em,
        ImagesUploaderService $imagesUploaderService,
        SluggerInterface $slugger
    ): Response {
        $this->denyAccessUnlessGranted('IS_AUTHENTICATED_FULLY');

        $trick = $repository->findOneBy(['slug' => $slug]);
        if (!$trick) {
            throw $this->createNotFoundException('Figure introuvable');
        }

        $currentUser = $this->getUser();

        if ($trick->getUser() === $currentUser) {
            // --- PROPRIÉTAIRE : Edition complète ---
            $form = $this->createForm(TrickContributeType::class, $trick);
            $form->handleRequest($request);

            if ($form->isSubmitted() && $form->isValid()) {
                $trick->setSlug(strtolower($slugger->slug($trick->getTitle())));

                // Featured image
                $featuredFile = $form->get('featuredImage')->getData();
                if ($featuredFile) {
                    if ($trick->getFeaturedImage()) {
                        $imagesUploaderService->delete($trick->getFeaturedImage());
                    }
                    $trick->setFeaturedImage($imagesUploaderService->upload($featuredFile));
                }

                // Gestion médias
                $this->handleMedia($trick, $form, $imagesUploaderService, $request, $em);

                $em->flush();
                $this->addFlash('success', 'Figure modifiée avec succès.');
                return $this->redirectToRoute('app_profile_index');
            }

            return $this->render('profile/tricks/edit.html.twig', [
                'form' => $form->createView(),
                'trick' => $trick,
            ]);
        }

        // --- CONTRIBUTEUR : ajout / suppression médias ---
        $form = $this->createForm(TrickContributeType::class, $trick);
        $form->handleRequest($request);

        if ($form->isSubmitted() && $form->isValid()) {
            $this->handleMediaContributor($trick, $form, $imagesUploaderService, $request, $em, $currentUser);
            $em->flush();
            $this->addFlash('success', 'Vos contributions ont été enregistrées.');
            return $this->redirectToRoute('app_profile_index');
        }

        return $this->render('profile/tricks/contribute.html.twig', [
            'form' => $form->createView(),
            'trick' => $trick,
        ]);
    }

    private function handleMediaContributor(
        Tricks $trick,
        $form,
        ImagesUploaderService $imagesUploaderService,
        Request $request,
        EntityManagerInterface $em,
        $currentUser
    ): void {
        // ---------- SUPPRESSION DES IMAGES ----------
        $removedImages = $request->request->all('removed_images', []);
        foreach ($removedImages as $filename) {
            foreach ($trick->getImages() as $image) {
                // L'utilisateur ne peut supprimer que **ses propres images**
                if ($image->getPicture() === $filename && $image->getUsers() === $currentUser) {
                    $imagesUploaderService->delete($filename);
                    $trick->removeImage($image);
                    $em->remove($image);
                }
            }
        }

        // ---------- AJOUT DES IMAGES ----------
        foreach ($form->get('images') as $imageForm) {
            $image = $imageForm->getData();
            $file  = $imageForm->get('file')->getData();
            if (!$file) continue;

            $filename = $imagesUploaderService->upload($file, 'image');
            $image->setPicture($filename);
            $image->setTrick($trick);
            $image->setUsers($currentUser); // attribution du contributeur

            if (!$trick->getImages()->contains($image)) {
                $trick->addImage($image);
            }

            $em->persist($image);
        }

        // ---------- SUPPRESSION DES VIDÉOS ----------
        $removedVideos = $request->request->all('removed_videos', []);
        foreach ($removedVideos as $id) {
            $video = $em->getRepository(Videos::class)->find($id);
            if ($video && $video->getUsers() === $currentUser) {
                $trick->removeVideo($video);
                $em->remove($video);
            }
        }

        // ---------- AJOUT DES VIDÉOS ----------
        foreach ($form->get('videos') as $videoForm) {
            $video = $videoForm->getData();
            if (!$video || !$video->getUrl()) continue;

            // Évite les doublons
            $exists = false;
            foreach ($trick->getVideos() as $existing) {
                if ($existing->getUrl() === $video->getUrl()) {
                    $exists = true;
                    break;
                }
            }
            if ($exists) continue;

            $video->setTrick($trick);
            $video->setUsers($currentUser);
            $trick->addVideo($video);
            $em->persist($video);
        }
    }


<?php

namespace App\Controller;

use App\Entity\Trick;
use App\Entity\Image;
use App\Form\TrickType;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\String\Slugger\SluggerInterface;

#[Route('/trick')]
class TrickController extends AbstractController
{
    #[Route('/add', name: 'trick_add')]
    public function add(Request $request, EntityManagerInterface $em, SluggerInterface $slugger): Response
    {
        $trick = new Trick();
        $form = $this->createForm(TrickType::class, $trick);
        $form->handleRequest($request);

        // Tableau pour stocker les fichiers temporaires
        $tempImages = [];

        if ($form->isSubmitted()) {
            // ---------------- Featured Image ----------------
            $featuredFile = $form->get('featuredImage')->getData();
            if ($featuredFile) {
                $filename = uniqid() . '.' . $featuredFile->guessExtension();
                $featuredFile->move(
                    $this->getParameter('featured_images_tmp_directory'),
                    $filename
                );
                $trick->setFeaturedImage($filename);
            }

            // ---------------- Images secondaires ----------------
            foreach ($form->get('images') as $imageForm) {
                $file = $imageForm->get('file')->getData();
                if ($file) {
                    $filename = uniqid() . '.' . $file->guessExtension();
                    $file->move(
                        $this->getParameter('images_tmp_directory'),
                        $filename
                    );
                    $tempImages[] = $filename;
                }
            }

            // ---------------- Videos ----------------
            foreach ($form->get('videos') as $videoForm) {
                $url = $videoForm->get('url')->getData();
                if ($url) {
                    $videoForm->getData()->setUrl($url); // déjà lié à l'entité
                }
            }

            // ----------------- Validation -----------------
            if ($form->isValid()) {
                // Déplacer images temporaires vers dossier définitif
                foreach ($tempImages as $filename) {
                    rename(
                        $this->getParameter('images_tmp_directory') . '/' . $filename,
                        $this->getParameter('images_directory') . '/' . $filename
                    );
                    $image = new Image();
                    $image->setPicture($filename);
                    $trick->addImage($image);
                }

                // Featured image → définitive
                if ($trick->getFeaturedImage()) {
                    $tmp = $this->getParameter('featured_images_tmp_directory') . '/' . $trick->getFeaturedImage();
                    $dest = $this->getParameter('featured_images_directory') . '/' . $trick->getFeaturedImage();
                    if (file_exists($tmp)) {
                        rename($tmp, $dest);
                    }
                }

                $em->persist($trick);
                $em->flush();

                $this->addFlash('success', 'Figure ajoutée avec succès !');

                return $this->redirectToRoute('trick_list');
            }
        }

        return $this->render('trick/add.html.twig', [
            'form' => $form->createView(),
            'tempImages' => $tempImages,
        ]);
    }

    #[Route('/edit/{id}', name: 'trick_edit')]
    public function edit(Trick $trick, Request $request, EntityManagerInterface $em, SluggerInterface $slugger): Response
    {
        $form = $this->createForm(TrickType::class, $trick);
        $form->handleRequest($request);

        // Images temporaires ajoutées avant validation
        $tempImages = [];

        if ($form->isSubmitted()) {
            // ---------------- Featured Image ----------------
            $featuredFile = $form->get('featuredImage')->getData();
            if ($featuredFile) {
                $filename = uniqid() . '.' . $featuredFile->guessExtension();
                $featuredFile->move(
                    $this->getParameter('featured_images_tmp_directory'),
                    $filename
                );
                $trick->setFeaturedImage($filename);
            }

            // ---------------- Images secondaires ----------------
            foreach ($form->get('images') as $imageForm) {
                $file = $imageForm->get('file')->getData();
                if ($file) {
                    $filename = uniqid() . '.' . $file->guessExtension();
                    $file->move(
                        $this->getParameter('images_tmp_directory'),
                        $filename
                    );
                    $tempImages[] = $filename;
                }
            }

            // ---------------- Suppression images existantes ----------------
            $removedImages = $request->request->all('removed_images') ?? [];
            foreach ($removedImages as $filename) {
                $image = $trick->getImages()->filter(fn($img) => $img->getPicture() === $filename)->first();
                if ($image) {
                    $trick->removeImage($image);
                    $path = $this->getParameter('images_directory') . '/' . $filename;
                    if (file_exists($path)) unlink($path);
                }
            }

            // ---------------- Suppression images temporaires ----------------
            $removedTempImages = $request->request->all('removed_temp_images') ?? [];
            foreach ($removedTempImages as $filename) {
                $path = $this->getParameter('images_tmp_directory') . '/' . $filename;
                if (file_exists($path)) unlink($path);
            }

            // ---------------- Validation finale ----------------
            if ($form->isValid()) {
                foreach ($tempImages as $filename) {
                    rename(
                        $this->getParameter('images_tmp_directory') . '/' . $filename,
                        $this->getParameter('images_directory') . '/' . $filename
                    );
                    $image = new Image();
                    $image->setPicture($filename);
                    $trick->addImage($image);
                }

                // Featured image → définitive
                if ($trick->getFeaturedImage()) {
                    $tmp = $this->getParameter('featured_images_tmp_directory') . '/' . $trick->getFeaturedImage();
                    $dest = $this->getParameter('featured_images_directory') . '/' . $trick->getFeaturedImage();
                    if (file_exists($tmp)) {
                        rename($tmp, $dest);
                    }
                }

                $em->persist($trick);
                $em->flush();

                $this->addFlash('success', 'Figure mise à jour !');
                return $this->redirectToRoute('trick_list');
            }
        }

        return $this->render('trick/add.html.twig', [
            'form' => $form->createView(),
            'tempImages' => $tempImages,
        ]);
    }
}
